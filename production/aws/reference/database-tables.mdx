---
title: "Database Tables"
sidebarTitle: "Database Tables"
description: "SQLAlchemy models and Alembic migrations"
keywords: ["tables", "models", "SQLAlchemy", "Alembic", "migrations", "schema", "ORM"]
---

AgentOS uses [SQLAlchemy](https://www.sqlalchemy.org/) for models and [Alembic](https://alembic.sqlalchemy.org/) for migrations.

## Adding a Table

1. Create table definition in `db/tables/`
2. Import in `db/tables/__init__.py`
3. Generate migration
4. Run migration

## Example: Users Table

Create `db/tables/user.py`:

```python db/tables/user.py
from datetime import datetime
from typing import Optional

from sqlalchemy.orm import Mapped, mapped_column
from sqlalchemy.sql.expression import text
from sqlalchemy.types import BigInteger, DateTime, String

from db.tables.base import Base


class UsersTable(Base):
    __tablename__ = "dim_users"

    id_user: Mapped[int] = mapped_column(
        BigInteger, primary_key=True, autoincrement=True, index=True
    )
    email: Mapped[str] = mapped_column(String, unique=True)
    is_active: Mapped[bool] = mapped_column(default=True)
    created_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True), server_default=text("now()")
    )
    updated_at: Mapped[Optional[datetime]] = mapped_column(
        DateTime(timezone=True), onupdate=text("now()")
    )
```

Register in `db/tables/__init__.py`:

```python db/tables/__init__.py
from db.tables.base import Base
from db.tables.user import UsersTable
```

## Generate Migration

```bash
docker exec -it ai-api alembic -c db/alembic.ini revision --autogenerate -m "Add users table"
```

This creates a migration file in `db/migrations/versions/`.

## Run Migration

### Local (dev)

```bash
docker exec -it ai-api alembic -c db/alembic.ini upgrade head
```

### Production

Option 1: Auto-migrate on startup (add to `prd_resources.py`):

```python
container_env = {
    ...
    "MIGRATE_DB": True,
}
```

Then update:
```bash
ag infra patch prd:aws:::td && ag infra patch prd:aws:::service
```

Option 2: Run manually via ECS Exec:

```bash
ECS_CLUSTER={infra_name}-prd
TASK_ARN=$(aws ecs list-tasks --cluster $ECS_CLUSTER --query "taskArns[0]" --output text)

aws ecs execute-command \
    --cluster $ECS_CLUSTER \
    --task $TASK_ARN \
    --container {infra_name}-prd \
    --interactive \
    --command "alembic -c db/alembic.ini upgrade head"
```

## Common Patterns

### Foreign Key Relationship

```python
from sqlalchemy import ForeignKey
from sqlalchemy.orm import relationship

class OrdersTable(Base):
    __tablename__ = "dim_orders"

    id_order: Mapped[int] = mapped_column(BigInteger, primary_key=True)
    id_user: Mapped[int] = mapped_column(ForeignKey("dim_users.id_user"))

    user: Mapped["UsersTable"] = relationship(back_populates="orders")
```

### Index for Queries

```python
from sqlalchemy import Index

class EventsTable(Base):
    __tablename__ = "fact_events"

    # Composite index for common queries
    __table_args__ = (
        Index("idx_events_user_created", "id_user", "created_at"),
    )
```

### Enum Column

```python
from enum import Enum
from sqlalchemy import Enum as SQLEnum

class Status(str, Enum):
    pending = "pending"
    complete = "complete"

class TasksTable(Base):
    status: Mapped[Status] = mapped_column(SQLEnum(Status), default=Status.pending)
```

## Naming Conventions

| Prefix | Use For | Example |
|--------|---------|---------|
| `dim_` | Dimension tables (entities) | `dim_users`, `dim_products` |
| `fact_` | Fact tables (events) | `fact_orders`, `fact_sessions` |
| `bridge_` | Many-to-many relationships | `bridge_user_roles` |

## Next Steps

- [Database Setup](/production/aws/configure/database) - Credentials and connections
- [Troubleshooting](/production/aws/operate/troubleshooting) - Common issues
